<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="theme-color" content="#F2A5FF" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700;900&display=swap"
      rel="stylesheet"
    />

    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <title>Play 2048</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        font-family: "Be Vietnam Pro", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }

      :root {
        --black: #000000;
        --black-on-theme: #000000;
        --white: #ffffff;
        --light-gray: #e5e5e5;
        --lightest-gray: #f1f1f1;
        --gray: #a3a3a3;
        --green: #3eb23e;
        --light-green: #a3fab3;
        --yellow: #d3b342;
        --theme: #f2a5ff;
        --theme-accent: #bb76c6;

        --columnsize: 4;
        --rowsize: 4;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --black: #e2e2e2;
          --white: #1c1c1c;
          --light-gray: #4c4c4c;
          --lightest-gray: #2f2f2f;
          --light-green: #3e5c3f;
        }
      }

      body {
        touch-action: none;

        display: grid;
        place-content: center;

        margin: 0;
        padding: 0;

        font-size: 1rem;

        background-color: var(--white);
        color: var(--black);
        stroke: var(--black);
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        margin: 0;
      }
      h1 {
        font-size: 1.375rem;
        font-weight: 900;
        line-height: 2rem;
      }
      nav h1 {
        color: var(--black-on-theme);
      }

      .dialog {
        appearance: none;
        border: none;
        outline: none;

        margin: 0;
        padding: 0;

        width: 100vw;
        height: 100vh;
        max-width: 100vw;
        max-height: 100vh;

        font-size: 0.75rem;

        background-color: var(--white);
        color: var(--black);
        stroke: var(--black);
      }
      .dialog[open] {
        display: flex;
        flex-flow: column nowrap;
      }

      .one-pane {
        height: 100%;
        overflow-y: auto;

        display: grid;
        grid-template-columns: 1fr;
        justify-content: flex-start;
        gap: 1rem;
        padding: 1rem;
      }
      .one-pane-two-pane {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      .one-pane-two-pane.centered {
        align-items: center;
      }

      .two-pane {
        height: 100%;
        overflow-y: auto;

        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        padding: 1rem;
      }

      .pane {
        display: flex;
        flex-flow: column nowrap;
        gap: 1rem;
      }
      .pane .card {
        border-radius: 0.5rem;
        padding: 0.5rem;
        white-space: nowrap;
      }
      .pane .button {
        width: 100%;
      }

      .button {
        appearance: none;
        border: none;
        outline: none;

        border-radius: 0.5rem;
        color: var(--black);
        cursor: pointer;
        font-size: 1rem;
        padding: 0.375rem 0.5rem;

        display: flex;
        flex-flow: row nowrap;
        align-items: center;
        justify-content: space-between;
      }
      .button:disabled {
        cursor: not-allowed;
        opacity: 0.4;
      }
      .button.small {
        font-size: 0.75rem;
      }
      .button svg {
        display: block;
      }
      .button span {
        padding: 0;
      }

      .checkbox {
        display: flex;
        flex-flow: row nowrap;
        align-items: center;
        gap: 0.25rem;
      }

      .strong {
        font-weight: bold;
      }
      .light-gray {
        background-color: var(--light-gray);
      }
      .lightest-gray {
        background-color: var(--lightest-gray);
      }
      .gray {
        background-color: var(--gray);
        color: var(--black-on-theme);
        stroke: var(--black-on-theme);
      }
      .white {
        background-color: var(--white);
      }
      .green {
        background-color: var(--green);
        color: var(--black-on-theme);
        stroke: var(--black-on-theme);
      }
      .light-green {
        background-color: var(--light-green);
      }
      .theme {
        background-color: var(--theme);
        color: var(--black-on-theme);
        stroke: var(--black-on-theme);
      }
      .accent {
        background-color: var(--theme-accent);
        color: var(--black-on-theme);
        stroke: var(--black-on-theme);
      }
      .yellow {
        background-color: var(--yellow);
        color: var(--black-on-theme);
        stroke: var(--black-on-theme);
      }
      .yellow-color {
        color: var(--yellow);
      }

      .sticky {
        position: sticky;
        top: 0;
      }
      .hidden {
        display: none;
      }

      .nav {
        width: 100%;
        padding: 1rem;

        display: flex;
        flex-flow: row nowrap;
        align-items: center;
        justify-content: space-between;
      }
      .nav-buttons {
        display: flex;
        flex-flow: row nowrap;
        align-items: center;
        gap: 0.5rem;

        flex: 1 1 0;
      }
      .nav-buttons.left {
        justify-content: start;
      }
      .nav-buttons.right {
        justify-content: end;
      }

      .icon-group {
        display: flex;
        flex-flow: row nowrap;
        align-items: center;
        gap: 0.375rem;
      }

      main#container {
        width: 100vw;
        height: 100vh;

        display: flex;
        flex-flow: column nowrap;
      }

      nav.nav {
        background-color: var(--theme);
      }

      section#game {
        width: 100%;
        height: 100%;
        flex-grow: 1;

        display: grid;
        grid-template-rows: 1fr;
        align-items: center;
        justify-content: stretch;
        padding: 2rem;
      }

      #board-container {
        position: relative;
        overflow: hidden;

        height: 100%;
        width: 100%;
      }
      :where(.lost > div:not(#lost)) {
        opacity: 0.1;
        transition: 205ms ease-out;
      }
      .board {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: min(100%, 30rem);

        display: grid;
        grid-template-columns: repeat(var(--rowsize, 4), 1fr);
        grid-template-rows: repeat(var(--columnsize, 4), 1fr);
        gap: min(2vw, 1rem);

        padding: 1rem;
      }
      .board.invisible {
        opacity: 0;
      }
      #board {
        background-color: var(--lightest-gray);
        border-radius: 0.5rem;
      }
      #anim {
        pointer-events: none;
      }
      #state {
        pointer-events: none;
      }
      #lost {
        display: flex;
        flex-flow: column nowrap;
        align-items: center;
        pointer-events: none;
      }
      .lost #lost {
        pointer-events: auto;
      }
      .board-square,
      .board-piece {
        width: 100%;
        height: 100%;
        aspect-ratio: 1 / 1;
        border-radius: 0.25rem;
      }
      .board-square {
        background-color: var(--light-gray);
      }
      .board-piece {
        display: grid;
        place-content: center;

        font-size: min(6vw, 2rem);
        font-weight: bold;
        background-color: var(--theme-accent);
      }
      .board-piece.invisible {
        visibility: hidden;
      }

      #overview-daily-games,
      #overview-random-games-container,
      #overview-random-games {
        display: flex;
        flex-flow: column nowrap;
        gap: 0.5rem;
      }

      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(-1rem);
        }
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }

        50% {
          transform: scale(1.2);
        }

        100% {
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body>
    <main id="container">
      <nav class="nav">
        <div class="nav-buttons left">
          <button id="overview-button" class="accent button">
            <svg
              width="20"
              height="20"
              viewBox="0 0 20 20"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M1.875 10L9.33667 2.5375C9.70333 2.17166 10.2967 2.17166 10.6625 2.5375L18.125 10M3.75 8.125V16.5625C3.75 17.08 4.17 17.5 4.6875 17.5H8.125V13.4375C8.125 12.92 8.545 12.5 9.0625 12.5H10.9375C11.455 12.5 11.875 12.92 11.875 13.4375V17.5H15.3125C15.83 17.5 16.25 17.08 16.25 16.5625V8.125M6.875 17.5H13.75"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>
        </div>
        <h1>2048</h1>
        <div class="nav-buttons right">
          <button id="more-button" class="accent button">
            <svg
              width="20"
              height="20"
              viewBox="0 0 15 15"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M2.34375 1.875V8.90625C2.34375 9.27921 2.49191 9.6369 2.75563 9.90062C3.01935 10.1643 3.37704 10.3125 3.75 10.3125H5.15625M2.34375 1.875H1.40625M2.34375 1.875H12.6562M5.15625 10.3125H9.84375M5.15625 10.3125L4.53125 12.1875M12.6562 1.875H13.5938M12.6562 1.875V8.90625C12.6562 9.27921 12.5081 9.6369 12.2444 9.90062C11.9806 10.1643 11.623 10.3125 11.25 10.3125H9.84375M9.84375 10.3125L10.4688 12.1875M4.53125 12.1875H10.4688M4.53125 12.1875L4.21875 13.125M10.4688 12.1875L10.7812 13.125M4.6875 7.5L6.5625 5.625L7.905 6.9675C8.53575 6.06206 9.3576 5.30614 10.3125 4.75313"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>
        </div>
      </nav>
      <section id="game">
        <div id="board-container">
          <div id="board" class="board">
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
            <div class="board-square"></div>
          </div>
          <div id="anim" class="board"></div>
          <div id="state" class="board"></div>
          <div id="lost" class="board invisible">
            <span>No valid moves left!</span>
            <button id="lost-reset" class="theme button">Start new game</button>
          </div>
        </div>
      </section>
    </main>

    <dialog id="overview-dialog" class="dialog">
      <div class="nav">
        <h1>Overview</h1>
        <button id="overview-close-button" class="light-gray button">
          <svg
            width="20"
            height="20"
            viewBox="0 0 20 20"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M5 15L15 5M5 5L15 15"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
      </div>
      <div class="two-pane">
        <div class="pane">
          <div class="icon-group">
            <svg
              width="22"
              height="22"
              viewBox="0 0 22 22"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M6.1875 2.75V4.8125M15.8125 2.75V4.8125M2.75 17.1875V6.875C2.75 6.32799 2.9673 5.80339 3.35409 5.41659C3.74089 5.0298 4.26549 4.8125 4.8125 4.8125H17.1875C17.7345 4.8125 18.2591 5.0298 18.6459 5.41659C19.0327 5.80339 19.25 6.32799 19.25 6.875V17.1875M2.75 17.1875C2.75 17.7345 2.9673 18.2591 3.35409 18.6459C3.74089 19.0327 4.26549 19.25 4.8125 19.25H17.1875C17.7345 19.25 18.2591 19.0327 18.6459 18.6459C19.0327 18.2591 19.25 17.7345 19.25 17.1875M2.75 17.1875V10.3125C2.75 9.76549 2.9673 9.24089 3.35409 8.85409C3.74089 8.4673 4.26549 8.25 4.8125 8.25H17.1875C17.7345 8.25 18.2591 8.4673 18.6459 8.85409C19.0327 9.24089 19.25 9.76549 19.25 10.3125V17.1875M11 11.6875H11.0073V11.6948H11V11.6875ZM11 13.75H11.0073V13.7573H11V13.75ZM11 15.8125H11.0073V15.8198H11V15.8125ZM8.9375 13.75H8.94483V13.7573H8.9375V13.75ZM8.9375 15.8125H8.94483V15.8198H8.9375V15.8125ZM6.875 13.75H6.88233V13.7573H6.875V13.75ZM6.875 15.8125H6.88233V15.8198H6.875V15.8125ZM13.0625 11.6875H13.0698V11.6948H13.0625V11.6875ZM13.0625 13.75H13.0698V13.7573H13.0625V13.75ZM13.0625 15.8125H13.0698V15.8198H13.0625V15.8125ZM15.125 11.6875H15.1323V11.6948H15.125V11.6875ZM15.125 13.75H15.1323V13.7573H15.125V13.75Z"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <strong>Daily games</strong>
          </div>
          <div id="overview-daily-games"></div>
        </div>
        <div class="pane">
          <div class="icon-group">
            <svg
              width="23"
              height="22"
              viewBox="0 0 23 22"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M18.375 11C18.375 9.87067 18.3328 8.75142 18.2485 7.64317C18.1836 6.76514 17.8055 5.93963 17.1829 5.31708C16.5604 4.69453 15.7349 4.31637 14.8568 4.25151C12.6221 4.08291 10.3779 4.08291 8.14317 4.25151C7.26513 4.31637 6.43963 4.69453 5.81707 5.31708C5.19452 5.93963 4.81636 6.76514 4.7515 7.64317C4.73592 7.84484 4.72217 8.04742 4.70933 8.25001M18.375 11L21.125 8.25001M18.375 11L15.625 8.25001M4.625 11C4.625 12.1293 4.66717 13.2486 4.7515 14.3568C4.81636 15.2349 5.19452 16.0604 5.81707 16.6829C6.43963 17.3055 7.26513 17.6836 8.14317 17.7485C10.3779 17.9172 12.6221 17.9172 14.8568 17.7485C15.7349 17.6836 16.5604 17.3055 17.1829 16.6829C17.8055 16.0604 18.1836 15.2349 18.2485 14.3568C18.2641 14.1552 18.2778 13.9526 18.2907 13.75M4.625 11L7.375 13.75M4.625 11L1.875 13.75"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <strong>Random games</strong>
          </div>
          <span>Want more than one game a day? Try a random game!</span>
          <div id="overview-random-games-container">
            <button
              id="overview-new-random-game"
              class="small light-gray button"
            >
              <span>New random game</span>
              <svg
                width="15"
                height="15"
                viewBox="0 0 15 15"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M7.5 2.8125V12.1875M12.1875 7.5H2.8125"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <div id="overview-random-games"></div>
          </div>
        </div>
      </div>
    </dialog>
  </body>
  <script id="variables">
    const Constants = {
      Api: {
        Dict: "/dict.txt",
      },
      WordLength: 5,
      Attempts: 6,
      KeyboardInputPrompt: "Click here to use your keyboard.",
      Colors: ["green", "yellow", "gray"],
      BotTopChoices: 10,
      RowSize: 4,
      ColumnSize: 4,
      HigherTierProbability: 0.1,
      KeyBindings: {
        up: ["ArrowUp", "w"],
        down: ["ArrowDown", "s"],
        left: ["ArrowLeft", "a"],
        right: ["ArrowRight", "d"],
      },
      Transforms: {
        up: (px) => `translateY(calc(-1 * ${px}px))`,
        down: (px) => `translateY(${px}px)`,
        left: (px) => `translateX(calc(-1 * ${px}px))`,
        right: (px) => `translateX(${px}px)`,
      },
    };

    const AppState = {
      currentThemeKey: undefined,
    };

    let GameDict = undefined;
    let ThemeHistory = {};
    let ThemeState = {};
    let GameState = {
      /** [t o p  r o w , ... , ... , b o t t o m  r o w] */
      board: new Array(Constants.RowSize * Constants.ColumnSize).fill(0),
    };
    let SwipeState = {
      active: false,
    };

    const Bindings = {
      Control: {
        OverviewButton: {
          Element: document.getElementById("overview-button"),
          Listener: undefined,
        },
        OverviewCloseButton: {
          Element: document.getElementById("overview-close-button"),
          Listener: undefined,
        },
        OverviewNewRandomGame: {
          Element: document.getElementById("overview-new-random-game"),
          Listener: undefined,
        },
        ResetButton: {
          Element: document.getElementById("lost-reset"),
          Listener: undefined,
        },
      },
      Dialogs: {
        OverviewDialog: document.getElementById("overview-dialog"),
        OverviewDailyGames: document.getElementById("overview-daily-games"),
        OverviewRandomGames: document.getElementById("overview-random-games"),
      },
      Board: {
        Container: document.getElementById("board-container"),
        Board: document.getElementById("board"),
        Animation: document.getElementById("anim"),
        State: document.getElementById("state"),
        Lost: document.getElementById("lost"),
        BoardTouchStart: {
          Element: document.getElementById("board"),
          Listener: undefined,
        },
        BoardTouchMove: {
          Element: document.getElementById("board"),
          Listener: undefined,
        },
        BoardTouchEnd: {
          Element: document.getElementById("board"),
          Listener: undefined,
        },
      },
      Document: {
        Element: document,
        Listener: undefined,
      },
    };
  </script>
  <script id="gameplay">
    const moveColumnOrRow = (columnOrRow, moveLeft = false) => {
      const normalized = moveLeft ? columnOrRow : columnOrRow.reverse();

      let lastSeen;
      let lastSeenIndex;
      const output = [];
      const diff = new Array(normalized.length).fill(0);
      const combined = new Array(normalized.length).fill(0);

      for (let i = 0; i < normalized.length; i++) {
        let char = normalized[i];

        if (char === 0) continue;

        if (lastSeen) {
          diff[lastSeenIndex] = lastSeenIndex - output.length;
          if (char === lastSeen) {
            diff[i] = i - output.length;
            combined[output.length] = char + 1;
            output.unshift(char + 1);
            lastSeen = undefined;
            lastSeenIndex = undefined;
          } else {
            output.unshift(lastSeen);
            lastSeen = char;
            lastSeenIndex = i;
          }
        } else {
          lastSeen = char;
          lastSeenIndex = i;
        }
      }

      if (lastSeen) {
        diff[lastSeenIndex] = lastSeenIndex - output.length;
        output.unshift(lastSeen);
      }

      const padded = [
        ...new Array(normalized.length - output.length).fill(0),
        ...output,
      ];

      return {
        board: moveLeft ? padded.reverse() : padded,
        diff: moveLeft ? diff : diff.reverse(),
        combined: moveLeft ? combined : combined.reverse(),
      };
    };

    const boardToColumns = (board) => {
      const columns = new Array(Constants.RowSize)
        .fill(0)
        .map(() => new Array(Constants.ColumnSize));
      for (let i = 0; i < board.length; i++) {
        columns[i % Constants.RowSize][Math.floor(i / Constants.ColumnSize)] =
          board[i];
      }
      return columns;
    };

    const columnsToBoard = (columns) => {
      const output = {
        board: [],
        diff: [],
        combined: [],
      };
      for (let i = 0; i < columns.length; i++) {
        for (let j = 0; j < columns[i].board.length; j++) {
          output.board[i + Constants.RowSize * j] = columns[i].board[j];
          output.diff[i + Constants.RowSize * j] = columns[i].diff[j];
          output.combined[i + Constants.RowSize * j] = columns[i].combined[j];
        }
      }
      return output;
    };

    const boardToRows = (board) => {
      const rows = new Array(Constants.ColumnSize)
        .fill(0)
        .map(() => new Array(Constants.RowSize));
      for (let i = 0; i < board.length; i++) {
        rows[Math.floor(i / Constants.RowSize)][i % Constants.ColumnSize] =
          board[i];
      }
      return rows;
    };

    const rowsToBoard = (rows) => {
      const output = {
        board: [],
        diff: [],
        combined: [],
      };
      for (let i = 0; i < rows.length; i++) {
        for (let j = 0; j < rows[i].board.length; j++) {
          output.board[i * Constants.RowSize + j] = rows[i].board[j];
          output.diff[i * Constants.RowSize + j] = rows[i].diff[j];
          output.combined[i * Constants.RowSize + j] = rows[i].combined[j];
        }
      }
      return output;
    };

    const calculateBoard = (board) => {
      return {
        up: columnsToBoard(
          boardToColumns(board).map((column) => moveColumnOrRow(column, true))
        ),
        down: columnsToBoard(
          boardToColumns(board).map((column) => moveColumnOrRow(column, false))
        ),
        left: rowsToBoard(
          boardToRows(board).map((row) => moveColumnOrRow(row, true))
        ),
        right: rowsToBoard(
          boardToRows(board).map((row) => moveColumnOrRow(row, false))
        ),
      };
    };

    const addNewPieces = (board, pieces = 1) => {
      const emptySquares = board.filter((square) => square === 0).length;
      const targetEmptySquares = new Set();
      while (targetEmptySquares.size < pieces) {
        targetEmptySquares.add(Math.floor(Math.random() * emptySquares));
      }

      const targetSquares = new Set();
      let currentEmptySquare = 0;
      for (let i = 0; i < GameState.board.length; i++) {
        if (board[i] !== 0) continue;

        if (targetEmptySquares.has(currentEmptySquare)) {
          targetSquares.add(i);
          board[i] = Math.random() < Constants.HigherTierProbability ? 2 : 1;
        }

        currentEmptySquare++;
      }

      return {
        board,
        targetSquares,
      };
    };

    const moveBoard = async (move) => {
      if (!GameState.premove)
        GameState.premove = calculateBoard(GameState.board);

      const state = GameState.premove[move];
      const isValidMove = state.diff.some((diff) => diff !== 0);

      if (!isValidMove) return;

      const previousBoard = GameState.board;

      const { board: newBoard, targetSquares } = addNewPieces(state.board);

      GameState.board = newBoard;

      GameState.premove = calculateBoard(GameState.board);

      if (
        Object.values(GameState.premove).every(({ diff }) =>
          diff.every((diff) => diff === 0)
        )
      ) {
        GameState.lost = true;
      }

      await animateState(
        previousBoard,
        newBoard,
        targetSquares,
        state.diff,
        state.combined,
        move
      );

      updateDisplayState();
    };

    const switchTheme = async (themeKey) => {
      if (!(themeKey in ThemeHistory))
        throw new Error("Attempted to switch to nonexistent theme!");
      AppState.currentThemeKey = themeKey;
      ThemeState = ThemeHistory[AppState.currentThemeKey];
      updateDisplayState();
    };

    const reset = async () => {
      const emptyBoard = () =>
        new Array(Constants.RowSize * Constants.ColumnSize).fill(0);

      const { board, targetSquares } = addNewPieces(emptyBoard(), 2);

      GameState = {
        board,
      };

      await animateState(
        emptyBoard(),
        GameState.board,
        targetSquares,
        emptyBoard(),
        emptyBoard()
      );

      updateDisplayState();
    };

    const load = async () => {
      const localThemeHistoryString =
        window.localStorage.getItem("2048_History");

      if (localThemeHistoryString) {
        ThemeHistory = JSON.parse(localThemeHistoryString);
      }

      const emptyBoard = () =>
        new Array(Constants.RowSize * Constants.ColumnSize).fill(0);

      GameState = {
        board: emptyBoard(),
      };

      const localGameStateString = window.localStorage.getItem("2048_State");

      if (localGameStateString) {
        GameState = JSON.parse(localGameStateString);
      } else {
        const { board } = addNewPieces(emptyBoard(), 2);

        GameState = {
          board,
        };
      }

      await animateState(
        emptyBoard(),
        GameState.board,
        GameState.board.reduce(
          (set, square, index) => (square === 0 ? set : set.add(index)),
          new Set()
        ),
        emptyBoard(),
        emptyBoard()
      );

      updateDisplayState();
    };

    const save = async () => {
      window.localStorage.setItem("2048_State", JSON.stringify(GameState));
      window.localStorage.setItem("2048_History", JSON.stringify(ThemeHistory));
    };

    const getThemedPiece = (state, customClasses = "") =>
      `<div data-state="${state}" class="board-piece ${
        state === 0 ? "invisible" : ""
      } ${customClasses}">${Math.pow(2, state)}</div>`;

    const animateState = async (
      previousBoard,
      newBoard,
      targetSquares,
      diff,
      combined,
      move = "left"
    ) => {
      if (GameState.lost) return;

      Bindings.Board.Animation.innerHTML = previousBoard
        .map((state, index) =>
          /** @todo theme */
          getThemedPiece(state)
        )
        .join("");

      const moveAnimationPieces = Array.from(
        document.querySelectorAll("#anim .board-piece")
      );

      Bindings.Board.Animation.classList.remove("invisible");
      Bindings.Board.State.classList.add("invisible");

      const movePx =
        parseFloat(getComputedStyle(Bindings.Board.Animation).gap) +
        moveAnimationPieces[0].getBoundingClientRect().width;

      const moveAnimationPromises = [];

      for (let i = 0; i < diff.length; i++) {
        if (diff[i] > 0) {
          const moveAnimation = moveAnimationPieces[i].animate(
            [
              { transform: "translateX(0) translateY(0)" },
              { transform: Constants.Transforms[move](diff[i] * movePx) },
            ],
            { duration: 105, easing: "ease-in", fill: "forwards" }
          );
          moveAnimationPromises.push(moveAnimation.finished);
        }
      }

      await Promise.all(moveAnimationPromises);

      Bindings.Board.Animation.innerHTML = newBoard
        .map((state, index) =>
          /** @todo theme */
          getThemedPiece(state)
        )
        .join("");

      const growAnimationPieces = Array.from(
        document.querySelectorAll("#anim .board-piece")
      );

      const growAnimationPromises = [];

      for (let i = 0; i < combined.length; i++) {
        if (targetSquares.has(i) || combined[i] > 0) {
          growAnimationPieces[i].classList.remove("invisible");
          const growAnimation = growAnimationPieces[i].animate(
            [{ transform: "scale(0.6)" }, { transform: "scale(1)" }],
            { duration: 105, easing: "ease-out", fill: "forwards" }
          );
          growAnimationPromises.push(growAnimation.finished);
        }
      }

      await Promise.all(growAnimationPromises);
    };

    const updateDisplayState = () => {
      if (GameState.lost) {
        Bindings.Board.Container.classList.add("lost");
        Bindings.Board.Lost.classList.remove("invisible");
      } else {
        Bindings.Board.Container.classList.remove("lost");
        Bindings.Board.Lost.classList.add("invisible");
      }

      Bindings.Board.State.classList.remove("invisible");
      Bindings.Board.Animation.classList.add("invisible");

      Bindings.Board.State.innerHTML = GameState.board
        .map((state) =>
          /** @todo theme */
          getThemedPiece(state)
        )
        .join("");

      Bindings.Dialogs.OverviewDailyGames.innerHTML = Object.entries(
        ThemeHistory
      )
        .sort()
        .reverse()
        .reduce(
          (innerHTML, [key, theme]) =>
            key === AppState.now || key.includes("+")
              ? innerHTML
              : (innerHTML += `<button data-theme-key=${key} class="small ${
                  AppState.currentThemeKey === key ? "theme" : "light-gray"
                } button">
                    <span>
                      <strong>
                        ${key.slice(5, 7)}/${key.slice(8, 10)}
                      </strong>
                    </span>
                  </button>`),
          `<button data-theme-key=${AppState.now} class="small ${
            AppState.currentThemeKey === AppState.now ? "theme" : "light-gray"
          } button">
            <span>
              <strong>Today</strong>
            </span>
          </button>`
        );
      Bindings.Dialogs.OverviewRandomGames.innerHTML = Object.entries(
        ThemeHistory
      )
        .sort()
        .reduce(
          (innerHTML, [key, theme]) =>
            !key.includes("+")
              ? innerHTML
              : (innerHTML += `<button data-theme-key=${key} class="small ${
                  key === AppState.currentThemeKey ? "theme" : "light-gray"
                } button">
                  <span>
                    <strong>
                      ${key.replace("+", " • ")}
                    </strong>
                  </span>
                </button>`),
          ""
        );

      updateButtonBindings();

      save();
    };

    const clearBinding = (binding, event = "pointerdown") => {
      binding.Element.removeEventListener(event, binding.Listener);
    };

    const updateBinding = (binding, callback, event = "pointerdown") => {
      binding.Element.removeEventListener(event, binding.Listener);
      binding.Listener = callback;
      binding.Element.addEventListener(event, binding.Listener);
    };

    const updateButtonBindings = () => {
      updateBinding(
        Bindings.Document,
        (e) => {
          if (!e.metaKey && e.key === "r") reset();

          if (!GameState.lost) {
            Object.entries(Constants.KeyBindings).forEach(([move, keys]) =>
              keys.includes(e.key) ? moveBoard(move) : {}
            );
          }
        },
        "keydown"
      );

      updateBinding(
        Bindings.Board.BoardTouchStart,
        (e) => {
          if (GameState.lost) return;

          SwipeState.active = true;
          SwipeState.x = e.clientX;
          SwipeState.y = e.clientY;
        },
        "pointerdown"
      );
      updateBinding(
        Bindings.Board.BoardTouchEnd,
        (e) => {
          if (GameState.lost) return;

          if (SwipeState.active) {
            SwipeState.active = false;
            const deltaX = e.clientX - SwipeState.x;
            const deltaY = e.clientY - SwipeState.y;

            if (Math.abs(deltaX) > Math.abs(deltaY)) {
              if (Math.abs(deltaX) > 16)
                moveBoard(deltaX > 0 ? "right" : "left");
            } else {
              if (Math.abs(deltaY) > 16) moveBoard(deltaY > 0 ? "down" : "up");
            }
          }
        },
        "pointerup"
      );

      Bindings.Dialogs.OverviewDialog.querySelectorAll(
        "button[data-theme-key]"
      ).forEach((button) =>
        button.addEventListener("click", () => {
          const key = button.dataset.gameKey;

          if (
            AppState.currentThemeKey === key &&
            AppState.currentThemeKey !== AppState.now &&
            confirm(`Delete theme ${key.replace("+", " • ")}?`)
          ) {
            delete ThemeHistory[key];
            switchGame(AppState.now);
          } else {
            switchGame(key);
            Bindings.Dialogs.OverviewDialog.close();
            Bindings.Control.OverviewButton.Element.blur();
          }
        })
      );
    };

    const updateControlButtonsOnce = () => {
      updateBinding(
        Bindings.Control.OverviewButton,
        () => {
          Bindings.Dialogs.OverviewDialog.showModal();
        },
        "click"
      );
      updateBinding(
        Bindings.Control.OverviewCloseButton,
        () => {
          Bindings.Dialogs.OverviewDialog.close();
          Bindings.Control.OverviewButton.Element.blur();
        },
        "click"
      );
      updateBinding(
        Bindings.Control.OverviewNewRandomGame,
        async () => {
          const lengthString = prompt(
            "How long should the word be? Choose any number greater than 4.",
            "5"
          );

          if (
            !lengthString ||
            Number.isNaN(parseInt(lengthString)) ||
            parseInt(lengthString) < 4
          ) {
            alert("That isn't a valid length!");
          } else {
            const length = parseInt(lengthString);

            await loadRandom(length);
            Bindings.Dialogs.OverviewDialog.close();
            Bindings.Control.OverviewButton.Element.blur();
          }
        },
        "click"
      );
      updateBinding(
        Bindings.Control.ResetButton,
        () => {
          reset();
        },
        "click"
      );
    };
  </script>
  <script id="run">
    const play = async () => {
      await load();

      updateControlButtonsOnce();

      Object.entries(ThemeHistory).forEach(([key, game]) => {
        if (key !== AppState.now && !key.includes("+")) {
          archiveGame(key);
        }
      });

      if ("serviceWorker" in navigator) {
        await navigator.serviceWorker.register("./sw.js", {
          scope: "/",
        });
      }
    };

    play();
  </script>
</html>
